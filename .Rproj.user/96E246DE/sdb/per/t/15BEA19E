{
    "collab_server" : "",
    "contents" : "#' Read in GDX and calculate variables that need variables produced by other report*.R functions, used in convGDX2MIF.R for the\n#' reporting\n#' \n#' Read in GDX and calculate variables that need variables produced by other report*.R functions\n#' \n#' \n#' @param gdx a GDX as created by readGDX, or the file name of a gdx\n#' @param output a magpie object containing all needed variables generated by other report*.R functions\n#' @author Lavinia Baumstark\n#' @examples\n#' \n#' \\dontrun{reportCrossVariables(gdx)}\n#' \n#' @export\n#' @importFrom gdx readGDX\n#' @importFrom magclass getYears getRegions mbind setNames dimSums mselect new.magpie setYears\nreportCrossVariables <- function(gdx,output=NULL){\n  if(is.null(output)){\n    stop(\"please provide a file containing all needed information\")\n  }\n  \n  ####### conversion factors ##########\n  TWa_2_EJ     <- 31.536\n  tdptwyr2dpgj <- 31.71   #TerraDollar per TWyear to Dollar per GJ\n  ####### read in needed data #########\n  ## sets\n  pe2se    <- readGDX(gdx,\"pe2se\")\n  ppfen_stat   <- readGDX(gdx,c(\"ppfen_stationary_dyn38\",\"ppfen_stationary_dyn28\",\"ppfen_stationary\"),format=\"first_found\", react = \"silent\")\n  if (length(ppfen_stat) == 0) ppfen_stat = NULL\n  ## parameter\n  pm_ts          <- readGDX(gdx,name='pm_ts',format=\"first_found\",restore_zeros=FALSE)\n  pm_ttot_val    <- readGDX(gdx,name='pm_ttot_val',format=\"first_found\",restore_zeros=FALSE)\n  ## equations\n  sebal.m        <- readGDX(gdx,name=c(\"q_balSe\",\"q_sebal\"),types=\"equations\",field=\"m\",format=\"first_found\")\n  budget.m       <- readGDX(gdx,name='qm_budget',types = \"equations\",field = \"m\",format = \"first_found\") # Alternative: calcPrice\n  demPE  <- readGDX(gdx,name=c(\"vm_demPe\",\"v_pedem\"),field=\"l\",restore_zeros=FALSE,format=\"first_found\") * TWa_2_EJ\n  demPE  <- demPE[pe2se]\n  ####### calculate minimal tempotal and regional resolution #####\n  y <- Reduce(intersect,list(getYears(output),getYears(sebal.m)))\n  r <- Reduce(intersect,list(getRegions(output),getRegions(sebal.m)))\n  output   <- output[,y,]\n  budget.m <- budget.m[,y,]\n  sebal.m  <- sebal.m[,y,]\n  pm_ts    <- pm_ts[,y,]\n  ####### calculate reporting parameters ############\n  tmp <- NULL \n  #\"light fuel oil\" is output of refineries, thus the price should include refinery costs => use sebal, not pebal, use average of sepet and sedie price.\n  if (\"seliq\" %in% pe2se$all_enty1) {\n    tmp <- mbind(tmp,setNames(sebal.m[,,\"seliq\"]/(budget.m+1e-10) * tdptwyr2dpgj,  \"Price|Light Fuel Oil|Secondary Level (US$2005/GJ)\" ))    \n  }else{\n    tmp <- mbind(tmp,setNames(\n      ( sebal.m[,,\"sepet\"] * output[r,,\"SE|Liquids|sepet (EJ/yr)\"]  + sebal.m[,,\"sedie\"] * output[r,,\"SE|Liquids|sedie (EJ/yr)\"])\n      / ( output[r,,\"SE|Liquids|sepet (EJ/yr)\"] + output[r,,\"SE|Liquids|sedie (EJ/yr)\"])\n      / (budget.m / pm_ts + 1e-10) * tdptwyr2dpgj,           \"Price|Light Fuel Oil|Secondary Level (US$2005/GJ)\" ))\n  }\n\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"SE|Electricity|Biomass (EJ/yr)\"]\n                 * output[r,,\"PE|Biomass|Energy Crops (EJ/yr)\"]\n                 / dimSums(mselect(demPE,all_enty=\"pebiolc\"),dim=3),   \"SE|Electricity|Biomass|Energy Crops (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"SE|Electricity|Biomass (EJ/yr)\"] \n                 * output[r,,\"PE|Biomass|Residues (EJ/yr)\"]\n                 / dimSums(mselect(demPE,all_enty=\"pebiolc\"),dim=3),   \"SE|Electricity|Biomass|Residues (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"SE|Liquids|Biomass (EJ/yr)\"] \n                 * output[r,,\"PE|Biomass|1st Generation (EJ/yr)\"]\n                 / output[r,,\"PE|+|Biomass (EJ/yr)\"],                     \"SE|Liquids|Biomass|1st Generation (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"SE|Liquids|Biomass (EJ/yr)\"] \n                 * output[r,,\"PE|Biomass|Residues (EJ/yr)\"]\n                 / output[r,,\"PE|+|Biomass (EJ/yr)\"],                     \"SE|Liquids|Biomass|Residues (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"SE|Liquids|Biomass (EJ/yr)\"] \n                 * output[r,,\"PE|Biomass|Energy Crops (EJ/yr)\"]\n                 / output[r,,\"PE|+|Biomass (EJ/yr)\"],                     \"SE|Liquids|Biomass|Energy Crops (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"FE|Transport|Freight (EJ/yr)\"] \n                 * output[r,,\"SE|Liquids|Oil (EJ/yr)\"]\n                 / output[r,,\"SE|Liquids (EJ/yr)\"],                     \"FE|Transport|Freight|Liquids|Oil (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"FE|Transport|Freight (EJ/yr)\"] \n                 * output[r,,\"SE|Liquids|Biomass (EJ/yr)\"]\n                 / output[r,,\"SE|Liquids (EJ/yr)\"],                     \"FE|Transport|Freight|Liquids|Biomass (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"FE|Transport|Freight (EJ/yr)\"] \n                 * output[r,,\"SE|Liquids|Coal (EJ/yr)\"]\n                 / output[r,,\"SE|Liquids (EJ/yr)\"],                     \"FE|Transport|Freight|Liquids|Coal (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"FE|Transport|Liquids (EJ/yr)\"] \n                 * output[r,,\"SE|Liquids|Biomass (EJ/yr)\"]\n                 / output[r,,\"SE|Liquids (EJ/yr)\"],                     \"FE|Transport|Liquids|Biomass (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"FE|Transport|Liquids (EJ/yr)\"] \n                 * output[r,,\"SE|Liquids|Coal (EJ/yr)\"]\n                 / output[r,,\"SE|Liquids (EJ/yr)\"],                     \"FE|Transport|Liquids|Coal (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"FE|Transport|Liquids (EJ/yr)\"] \n                 * output[r,,\"SE|Liquids|Oil (EJ/yr)\"]\n                 / output[r,,\"SE|Liquids (EJ/yr)\"],                     \"FE|Transport|Liquids|Oil (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                 ( output[r,,\"FE|Transport|Pass (EJ/yr)\"] - output[r,,\"FE|Transport|Electricity (EJ/yr)\"] )\n                 * output[r,,\"SE|Liquids|Oil (EJ/yr)\"]\n                 / output[r,,\"SE|Liquids (EJ/yr)\"],                     \"FE|Transport|Pass|Liquids|Oil (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                 ( output[r,,\"FE|Transport|Pass (EJ/yr)\"] - output[r,,\"FE|Transport|Electricity (EJ/yr)\"] )\n                 * output[r,,\"SE|Liquids|Biomass (EJ/yr)\"]\n                 / output[r,,\"SE|Liquids (EJ/yr)\"],                     \"FE|Transport|Pass|Liquids|Biomass (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                 ( output[r,,\"FE|Transport|Pass (EJ/yr)\"] - output[r,,\"FE|Transport|Electricity (EJ/yr)\"] )\n                 * output[r,,\"SE|Liquids|Coal (EJ/yr)\"]\n                 / output[r,,\"SE|Liquids (EJ/yr)\"],                     \"FE|Transport|Pass|Liquids|Coal (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"FE|Transport|Pass|Road|LDV|Liquids (EJ/yr)\"] \n                 * output[r,,\"SE|Liquids|Biomass (EJ/yr)\"]\n                 / output[r,,\"SE|Liquids (EJ/yr)\"],                     \"FE|Transport|Pass|Road|LDV|Liquids|Biomass (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"FE|Transport|Pass|Road|LDV|Liquids (EJ/yr)\"] \n                 * output[r,,\"SE|Liquids|Coal (EJ/yr)\"]\n                 / output[r,,\"SE|Liquids (EJ/yr)\"],                     \"FE|Transport|Pass|Road|LDV|Liquids|Coal (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"FE|Transport|Pass|Road|LDV|Liquids (EJ/yr)\"] \n                 * output[r,,\"SE|Liquids|Oil (EJ/yr)\"]\n                 / output[r,,\"SE|Liquids (EJ/yr)\"],                     \"FE|Transport|Pass|Road|LDV|Liquids|Oil (EJ/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"Energy Investments (billion US$2005/yr)\"]\n                  -output[r,,\"Energy Investments|Electricity (billion US$2005/yr)\"],\"Energy Investments|Non-Elec (billion US$2005/yr)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[r,,\"SE|Electricity|Gas (EJ/yr)\"] / output[r,,\"Cap|Electricity|Gas (GW)\"] / TWa_2_EJ * 1000,\n                   \"Capacity Factor|Electricity|Gas (GW)\"))\n  \n    # add global values\n  tmp <- mbind(tmp,dimSums(tmp,dim=1))\n  \n  # correct global values for intensive variables (prices, LCOES, Capacity factors) \n  map <- data.frame(region=getRegions(tmp[\"GLO\",,,invert=TRUE]),world=\"GLO\",stringsAsFactors=FALSE)\n  tmp[\"GLO\",,\"Price|Light Fuel Oil|Secondary Level (US$2005/GJ)\"] <- \n            speed_aggregate(tmp[map$region,,\"Price|Light Fuel Oil|Secondary Level (US$2005/GJ)\"],map,weight=output[map$region,,\"SE|Liquids|Oil (EJ/yr)\"])\n  tmp[\"GLO\",,\"Capacity Factor|Electricity|Gas (GW)\"] <- \n    speed_aggregate(tmp[map$region,,\"Capacity Factor|Electricity|Gas (GW)\"],map,weight=output[map$region,,\"Cap|Electricity|Gas (GW)\"])\n  \n  # variables that are calculated for all regions including GLO in the same way\n  tmp <- mbind(tmp,setNames(\n                   output[,,\"FE (EJ/yr)\"] * 1000\n                 / output[,,\"GDP|MER (billion US$2005/yr)\"],           \"Intensity|GDP|Final Energy (MJ/US$2005)\"))\n  tmp <- mbind(tmp,setNames(\n                   (output[,,\"Emi|CO2|Fossil Fuels and Industry (Mt CO2/yr)\"] - output[,,\"Emi|CO2|Fossil Fuels and Industry|Cement process (Mt CO2/yr)\"])\n                  / output[,,\"FE (EJ/yr)\"],                 \"Intensity|Final Energy|CO2 (Mt CO2/EJ)\"))\n  tmp <- mbind(tmp,setNames(\n                   output[,,\"Emi|GHGtot (Mt CO2-equiv/yr)\"]\n                  / output[,,\"GDP|MER (billion US$2005/yr)\"],                 \"Intensity|GDP|CO2 (Mt CO2-equiv/US$2005)\"))\n  tmp <- mbind(tmp,setNames(\n                  output[,,\"Emi|GHGtot (Mt CO2-equiv/yr)\"]\n                  / output[,,\"FE (EJ/yr)\"],                 \"Intensity|Final Energy|CO2 (Mt CO2-equiv/EJ)\"))\n  \n  # Energy expenditures\n  tmp <- mbind(tmp,setNames(\n    output[,,\"FE|Transport|Liquids (EJ/yr)\"] * output[,,\"Price|Final Energy|Liquids|Transport (US$2005/GJ)\"] +\n    output[,,\"FE|Transport|Hydrogen (EJ/yr)\"] * output[,,\"Price|Final Energy|Hydrogen|Transport (US$2005/GJ)\"] +\n    output[,,\"FE|Transport|Electricity (EJ/yr)\"] * output[,,\"Price|Final Energy|Electricity|Transport (US$2005/GJ)\"], \n                       \"Expenditure|Transport|Fuel (bil. $US/yr)\"))\n  \n  # calculate intensities growth\n  int_gr <- new.magpie(getRegions(tmp),getYears(tmp),c(\"Intensity Growth|GDP|Final Energy (% pa)\",\"Intensity Growth|GDP|Final Energy to 2005 (% pa)\",\n                                                       \"Intensity Growth|GDP|CO2-equiv (% pa)\",\"Intensity Growth|GDP|CO2-equiv to 2005 (% pa)\",\n                                                       \"Intensity Growth|Final Energy|CO2-equiv (% pa)\",\"Intensity Growth|Final Energy|CO2-equiv to 2005 (% pa)\",\n                                                       \"Intensity Growth|Final Energy|CO2 (% pa)\",\"Intensity Growth|Final Energy|CO2 to 2005 (% pa)\"),fill=0)\n  for (t in getYears(tmp[,which(getYears(tmp,as.integer=TRUE)>2005),])){\n    int_gr[,t,\"Intensity Growth|GDP|Final Energy (% pa)\"] <- \n        ( \n          ( \n              (tmp[,t,\"Intensity|GDP|Final Energy (MJ/US$2005)\"] / setYears(tmp[,(which(getYears(tmp)==t)-1),\"Intensity|GDP|Final Energy (MJ/US$2005)\"],t))\n           ^ (1 / ( getYears(tmp[,t,],as.integer=TRUE) - getYears(tmp[,(which(getYears(tmp)==t)-1),],as.integer=TRUE) ) )\n          ) - 1\n        ) * 100\n    int_gr[,t,\"Intensity Growth|GDP|Final Energy to 2005 (% pa)\"] <- \n      ( \n        ( \n          (tmp[,t,\"Intensity|GDP|Final Energy (MJ/US$2005)\"] / setYears(tmp[,2005,\"Intensity|GDP|Final Energy (MJ/US$2005)\"],t))\n          ^ (1 / ( getYears(tmp[,t,],as.integer=TRUE) - 2005 ) )\n        ) - 1\n      ) * 100\n    int_gr[,t,\"Intensity Growth|Final Energy|CO2 (% pa)\"] <- \n      ( \n        ( \n          (tmp[,t,\"Intensity|Final Energy|CO2 (Mt CO2/EJ)\"] / setYears(tmp[,(which(getYears(tmp)==t)-1),\"Intensity|Final Energy|CO2 (Mt CO2/EJ)\"],t))\n          ^ (1 / ( getYears(tmp[,t,],as.integer=TRUE) - getYears(tmp[,(which(getYears(tmp)==t)-1),],as.integer=TRUE) ) )\n        ) - 1\n      ) * 100\n    int_gr[,t,\"Intensity Growth|Final Energy|CO2 to 2005 (% pa)\"] <- \n      ( \n        ( \n          (tmp[,t,\"Intensity|Final Energy|CO2 (Mt CO2/EJ)\"] / setYears(tmp[,2005,\"Intensity|Final Energy|CO2 (Mt CO2/EJ)\"],t))\n          ^ (1 / ( getYears(tmp[,t,],as.integer=TRUE) - 2005 ) )\n        ) - 1\n      ) * 100\n    int_gr[,t,\"Intensity Growth|GDP|CO2-equiv (% pa)\"] <- \n      ( \n        ( \n          (tmp[,t,\"Intensity|GDP|CO2 (Mt CO2-equiv/US$2005)\"] / setYears(tmp[,(which(getYears(tmp)==t)-1),\"Intensity|GDP|CO2 (Mt CO2-equiv/US$2005)\"],t))\n          ^ (1 / ( getYears(tmp[,t,],as.integer=TRUE) - getYears(tmp[,(which(getYears(tmp)==t)-1),],as.integer=TRUE) ) )\n        ) - 1\n      ) * 100\n    int_gr[,t,\"Intensity Growth|GDP|CO2-equiv to 2005 (% pa)\"] <- \n      ( \n        ( \n          (tmp[,t,\"Intensity|GDP|CO2 (Mt CO2-equiv/US$2005)\"] / setYears(tmp[,2005,\"Intensity|GDP|CO2 (Mt CO2-equiv/US$2005)\"],t))\n          ^ (1 / ( getYears(tmp[,t,],as.integer=TRUE) - 2005 ) )\n        ) - 1\n      ) * 100\n    int_gr[,t,\"Intensity Growth|Final Energy|CO2-equiv (% pa)\"] <- \n      ( \n        ( \n          (tmp[,t,\"Intensity|Final Energy|CO2 (Mt CO2-equiv/EJ)\"] / setYears(tmp[,(which(getYears(tmp)==t)-1),\"Intensity|Final Energy|CO2 (Mt CO2-equiv/EJ)\"],t))\n          ^ (1 / ( getYears(tmp[,t,],as.integer=TRUE) - getYears(tmp[,(which(getYears(tmp)==t)-1),],as.integer=TRUE) ) )\n        ) - 1\n      ) * 100\n    int_gr[,t,\"Intensity Growth|Final Energy|CO2-equiv to 2005 (% pa)\"] <- \n      ( \n        ( \n          (tmp[,t,\"Intensity|Final Energy|CO2 (Mt CO2-equiv/EJ)\"] / setYears(tmp[,2005,\"Intensity|Final Energy|CO2 (Mt CO2-equiv/EJ)\"],t))\n          ^ (1 / ( getYears(tmp[,t,],as.integer=TRUE) - 2005 ) )\n        ) - 1\n      ) * 100\n  }\n\n  if (!is.null(ppfen_stat)){\n    tmp <- mbind(tmp,setNames(\n      output[,,\"FE|Other Sector|Gases (EJ/yr)\"] \n      * output[,,\"SE|Gases|Biomass (EJ/yr)\"]\n      / output[,,\"SE|Gases (EJ/yr)\"],\"FE|Other Sector|Gases|Biomass (EJ/yr)\"))\n    \n    tmp <- mbind(tmp,setNames(\n      output[,,\"FE|Other Sector|Gases (EJ/yr)\"] \n      * output[,,\"SE|Gases|Natural Gas (EJ/yr)\"]\n      / output[,,\"SE|Gases (EJ/yr)\"],\"FE|Other Sector|Gases|Natural Gas (EJ/yr)\"))\n    \n    tmp <- mbind(tmp,setNames(\n      output[,,\"FE|Other Sector|Gases (EJ/yr)\"] \n      * output[,,\"SE|Gases|Coal (EJ/yr)\"]\n      / output[,,\"SE|Gases (EJ/yr)\"],\"FE|Other Sector|Gases|Coal (EJ/yr)\"))\n    \n  }else{\n    \n    tmp <- mbind(tmp,setNames(\n      output[,,\"FE|Buildings|Gases (EJ/yr)\"] \n      * output[,,\"SE|Gases|Biomass (EJ/yr)\"]\n      / output[,,\"SE|Gases (EJ/yr)\"],\"FE|Buildings|Gases|Biomass (EJ/yr)\"))\n    \n    tmp <- mbind(tmp,setNames(\n      output[,,\"FE|Buildings|Gases (EJ/yr)\"] \n      * output[,,\"SE|Gases|Natural Gas (EJ/yr)\"]\n      / output[,,\"SE|Gases (EJ/yr)\"],\"FE|Buildings|Gases|Natural Gas (EJ/yr)\"))\n    \n    tmp <- mbind(tmp,setNames(\n      output[,,\"FE|Buildings|Gases (EJ/yr)\"] \n      * output[,,\"SE|Gases|Coal (EJ/yr)\"]\n      / output[,,\"SE|Gases (EJ/yr)\"],\"FE|Buildings|Gases|Coal (EJ/yr)\"))\n    \n    tmp <- mbind(tmp,setNames(\n      output[,,\"FE|Industry|Gases (EJ/yr)\"] \n      * output[,,\"SE|Gases|Biomass (EJ/yr)\"]\n      / output[,,\"SE|Gases (EJ/yr)\"],\"FE|Industry|Gases|Biomass (EJ/yr)\"))\n    \n    tmp <- mbind(tmp,setNames(\n      output[,,\"FE|Industry|Gases (EJ/yr)\"] \n      * output[,,\"SE|Gases|Natural Gas (EJ/yr)\"]\n      / output[,,\"SE|Gases (EJ/yr)\"],\"FE|Industry|Gases|Natural Gas (EJ/yr)\"))\n    \n    tmp <- mbind(tmp,setNames(\n      output[,,\"FE|Industry|Gases (EJ/yr)\"] \n      * output[,,\"SE|Gases|Coal (EJ/yr)\"]\n      / output[,,\"SE|Gases (EJ/yr)\"],\"FE|Industry|Gases|Coal (EJ/yr)\"))\n    \n  }\n \n  out <- mbind(tmp, int_gr)\n  return(out)\n}\n\n\n",
    "created" : 1493215296489.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "78059435",
    "id" : "15BEA19E",
    "lastKnownWriteTime" : 1533202912,
    "last_content_update" : 1533202912,
    "path" : "~/Documents/work/libraries/remind/R/reportCrossVariables.R",
    "project_path" : "R/reportCrossVariables.R",
    "properties" : {
    },
    "relative_order" : 10,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}