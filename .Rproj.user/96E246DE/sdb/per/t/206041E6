{
    "collab_server" : "",
    "contents" : "#' Read in GDX and calculate primary energy, used in convGDX2MIF.R for the\n#' reporting\n#' \n#' Read in primary energy information from GDX file, information used in\n#' convGDX2MIF.R for the reporting\n#' \n#' \n#' @param gdx a GDX as created by readGDX, or the file name of a gdx\n#' @author Lavinia Baumstark\n#' @examples\n#' \n#' \\dontrun{reportPE(gdx)}\n#' \n#' @export\n#' @importFrom gdx readGDX\n#' @importFrom magclass mselect getYears dimSums getNames<- mbind setNames\nreportPE <- function(gdx){\n  ####### conversion factors ##########\n  TWa_2_EJ     <- 31.536\n  ####### read in needed data #########\n  ## sets\n  pe2se    <- readGDX(gdx,\"pe2se\")\n  tefosccs <- readGDX(gdx,c(\"teFosCCS\",\"tefosccs\"),format=\"first_found\")\n  teccs    <- readGDX(gdx,c(\"teCCS\",\"teccs\"),format=\"first_found\")\n  tenoccs  <- readGDX(gdx,c(\"teNoCCS\",\"tenoccs\"),format=\"first_found\")\n  pebio    <- readGDX(gdx,c(\"peBio\",\"pebio\"),format=\"first_found\")\n  sety     <- readGDX(gdx,c(\"entySe\",\"sety\"),format=\"first_found\")\n  oc2te    <- readGDX(gdx,c(\"pc2te\",\"oc2te\"),format=\"first_found\")\n  potentialseLiq <- c(\"seliq\",\"sepet\",\"sedie\")  # the sety liquids changed from sepet+sedie to seLiq in REMIND 1.7\n  se_Liq    <- intersect(potentialseLiq,sety)\n  enty2rlf <- readGDX(gdx,c(\"pe2rlf\",\"enty2rlf\"),format=\"first_found\")\n  ## parameter\n  dataoc_tmp       <- readGDX(gdx,c(\"pm_prodCouple\",\"p_prodCouple\",\"p_dataoc\"),restore_zeros=FALSE,format=\"first_found\") \n  dataoc_tmp[is.na(dataoc_tmp)] <- 0\n  p_costsPEtradeMp <- readGDX(gdx,\"p_costsPEtradeMp\",restore_zeros=FALSE)\n  p_macBase        <- readGDX(gdx,c(\"p_macBaseMagpie\",\"p_macBase\"),format=\"first_found\")*TWa_2_EJ\n#  p_macEmi         <- readGDX(gdx,c(\"p_macEmi\"),format=\"first_found\")*TWa_2_EJ\n  ## variables\n  demPE  <- readGDX(gdx,name=c(\"vm_demPe\",\"v_pedem\"),field=\"l\",restore_zeros=FALSE,format=\"first_found\")*TWa_2_EJ\n  demPE  <- demPE[pe2se]\n  prodSE <- readGDX(gdx,name=c(\"vm_prodSe\",\"v_seprod\"),field=\"l\",restore_zeros=FALSE,format=\"first_found\")*TWa_2_EJ\n  prodSE <- mselect(prodSE,all_enty1=sety)\n  fuelex <- readGDX(gdx,c(\"vm_fuExtr\",\"vm_fuelex\"),field=\"l\",format=\"first_found\")*TWa_2_EJ\n  Mport  <- readGDX(gdx,c(\"vm_Mport\"),field=\"l\",format=\"first_found\")*TWa_2_EJ\n  Xport  <- readGDX(gdx,c(\"vm_Xport\"),field=\"l\",format=\"first_found\")*TWa_2_EJ\n  ####### calculate minimal tempotal resolution #####\n  y <- Reduce(intersect,list(getYears(demPE),getYears(prodSE)))\n  demPE  <- demPE[,y,]\n  prodSE <- prodSE[,y,]\n  fuelex <- fuelex[,y,]\n  Mport  <- Mport[,y,]\n  Xport  <- Xport[,y,]\n  p_macBase <- p_macBase[,y,]\n#  p_macEmi  <- p_macEmi[,y,]\n  ####### fix negative values to 0 ##################\n  #### adjust regional dimension of dataoc\n  dataoc <- new.magpie(getRegions(prodSE),getYears(dataoc_tmp),magclass::getNames(dataoc_tmp),fill=0)\n  dataoc[getRegions(dataoc_tmp),,] <- dataoc_tmp\n  getSets(dataoc) <- getSets(dataoc_tmp)\n  dataoc[dataoc<0] <- 0\n  ####### internal function for reporting ###########\n  pe_carrier <- function(demPE,dataoc,oc2te,sety,pecarrier,secarrier,te=pe2se$all_te,name=NULL){\n    ## identify all techs with secarrier as a main product    \n    sub1_oc2te <- oc2te[(oc2te$all_enty %in% pecarrier) & (oc2te$all_enty1 %in% secarrier) & (oc2te$all_enty2 %in% sety)    & (oc2te$all_te %in% te),]\n    ## identify all techs with secarrier as a couple product        \n    sub2_oc2te <- oc2te[(oc2te$all_enty %in% pecarrier) & (oc2te$all_enty1 %in% sety)    & (oc2te$all_enty2 %in% secarrier) & (oc2te$all_te %in% te),]\n    ## all primary energy demand with secarrier as a main product\n    x1 <- dimSums(mselect(demPE,all_enty=pecarrier,all_enty1=secarrier,all_te=te),dim=3)  \n    ## negative term for couple products by technologies with secarrier as a main product\n    x2 <- dimSums(demPE[sub1_oc2te]*dataoc[sub1_oc2te]/(1+dataoc[sub1_oc2te]),dim=3)\n    ## additional pe demand for technologies with secarrier as a couple product\n    x3 <- dimSums(demPE[sub2_oc2te]*dataoc[sub2_oc2te]/(1+dataoc[sub2_oc2te]),dim=3)\n    out <- (x1-x2+x3)\n    if(!is.null(name)) magclass::getNames(out) <- name\n    return(out)\n  }\n  ####### calculate reporting parameters ############\n  tmp1 <- NULL \n  tmp1 <- mbind(\n          setNames(dimSums(demPE[,,c(\"peoil\",\"pecoal\",\"pegas\")],dim=3),          \"PE|Fossil (EJ/yr)\"),\n          setNames(dimSums(demPE[,,tefosccs],dim=3),                             \"PE|Fossil|w/ CCS (EJ/yr)\"),\n          setNames(dimSums(demPE[,,c(\"peoil\",\"pecoal\",\"pegas\")],dim=3) \n                 - dimSums(demPE[,,tefosccs],dim=3),                             \"PE|Fossil|w/o CCS (EJ/yr)\"),\n          setNames(dimSums(demPE[,,\"pecoal\"],dim=3),                             \"PE|+|Coal (EJ/yr)\"),\n          setNames(dimSums(mselect(demPE,all_enty=\"pecoal\",all_te=teccs),dim=3), \"PE|Coal|w/ CCS (EJ/yr)\"),\n          setNames(dimSums(demPE[,,\"pecoal\"],dim=3)\n                 - dimSums(mselect(demPE,all_enty=\"pecoal\",all_te=teccs),dim=3), \"PE|Coal|w/o CCS (EJ/yr)\"),\n          setNames(dimSums(demPE[,,\"peoil\"],dim=3),                              \"PE|+|Oil (EJ/yr)\"),\n          setNames(dimSums(mselect(demPE,all_enty=\"peoil\",all_te=tenoccs),dim=3),\"PE|Oil|w/o CCS (EJ/yr)\"),\n          setNames(dimSums(demPE[,,\"pegas\"],dim=3),                              \"PE|+|Gas (EJ/yr)\"),\n          setNames(dimSums(mselect(demPE,all_enty=\"pegas\",all_te=teccs),dim=3),  \"PE|Gas|w/ CCS (EJ/yr)\"),\n          setNames(dimSums(demPE[,,\"pegas\"],dim=3)\n                 - dimSums(mselect(demPE,all_enty=\"pegas\",all_te=teccs),dim=3),  \"PE|Gas|w/o CCS (EJ/yr)\"),\n          setNames(dimSums(demPE[,,pebio],dim=3),                                \"PE|+|Biomass (EJ/yr)\"),\n          setNames(dimSums(mselect(demPE,all_enty=pebio,all_te=teccs),dim=3),    \"PE|Biomass|w/ CCS (EJ/yr)\"),\n          setNames(dimSums(demPE[,,pebio],dim=3)\n                 - dimSums(mselect(demPE,all_enty=pebio,all_te=teccs),dim=3),    \"PE|Biomass|w/o CCS (EJ/yr)\"),\n          setNames(dimSums(mselect(demPE,all_enty=pebio,all_te=\"biotr\"),dim=3),  \"PE|Biomass|Traditional (EJ/yr)\"),\n          setNames(dimSums(demPE[,,c(\"pebios\",\"pebioil\")],dim=3),                \"PE|Biomass|1st Generation (EJ/yr)\"),\n          setNames(dimSums(demPE[,,pebio],dim=3)\n                 - dimSums(mselect(demPE,all_enty=pebio,all_te=\"biotr\"),dim=3),  \"PE|Biomass|Modern (EJ/yr)\")\n          )\n  # Nuclear and Renewables\n  tmp2 <- NULL \n  tmp2 <- mbind(tmp2,setNames(dimSums(mselect(prodSE,all_enty=\"peur\"),dim=3),     \"PE|+|Nuclear (EJ/yr)\"))\n  tmp2 <- mbind(tmp2,setNames(dimSums(mselect(prodSE,all_enty=c(\"pegeo\",\"pehyd\",\"pewin\",\"pesol\")),dim=3),\"PE|Non-Biomass Renewables (EJ/yr)\"))\n  tmp2 <- mbind(tmp2,setNames(dimSums(mselect(prodSE,all_enty=\"pehyd\"),dim=3),    \"PE|+|Hydro (EJ/yr)\"))\n  tmp2 <- mbind(tmp2,setNames(dimSums(mselect(prodSE,all_enty=\"pewin\"),dim=3),    \"PE|+|Wind (EJ/yr)\"))\n  tmp2 <- mbind(tmp2,setNames(dimSums(mselect(prodSE,all_enty=\"pesol\"),dim=3),    \"PE|+|Solar (EJ/yr)\"))\n  tmp2 <- mbind(tmp2,setNames(dimSums(mselect(prodSE,all_enty=\"pegeo\"),dim=3),    \"PE|+|Geothermal (EJ/yr)\"))\n                \n  # primary energy consumption per carrier  --- use function declared above\n  tmp3 <- mbind(pe_carrier(demPE,dataoc,oc2te,sety,pebio,\"seel\",                     name=\"PE|Biomass|Electricity (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,\"seel\",teccs,               name=\"PE|Biomass|Electricity|w/ CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,\"seel\",tenoccs,             name=\"PE|Biomass|Electricity|w/o CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,\"sega\",                     name=\"PE|Biomass|Gases (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,\"seh2\",                     name=\"PE|Biomass|Hydrogen (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,\"seh2\",teccs,               name=\"PE|Biomass|Hydrogen|w/ CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,\"seh2\",tenoccs,             name=\"PE|Biomass|Hydrogen|w/o CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,se_Liq ,                    name=\"PE|Biomass|Liquids (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,se_Liq,teccs,               name=\"PE|Biomass|Liquids|w/ CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,se_Liq,tenoccs,             name=\"PE|Biomass|Liquids|w/o CCS (EJ/yr)\"),\n                \n                pe_carrier(demPE,dataoc,oc2te,sety,\"pebiolc\",se_Liq ,                name=\"PE|Biomass|Liquids|Cellulosic (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pebiolc\",se_Liq ,teccs,          name=\"PE|Biomass|Liquids|Cellulosic|w/ CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pebiolc\",se_Liq ,tenoccs,        name=\"PE|Biomass|Liquids|Cellulosic|w/o CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,c(\"pebioil\", \"pebios\"), se_Liq ,  name=\"PE|Biomass|Liquids|Non-Cellulosic (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pebios\",se_Liq ,                 name=\"PE|Biomass|Liquids|Conventional Ethanol (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,se_Liq , c(\"bioftrec\", \"bioftcrec\",\"biodiesel\"),\n                                                                                     name=\"PE|Biomass|Liquids|Biodiesel (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,se_Liq , c(\"bioftcrec\"),\n                                                                                     name=\"PE|Biomass|Liquids|Biodiesel|w/ CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,se_Liq , c(\"bioftrec\",\"biodiesel\"),\n                                                                                     name=\"PE|Biomass|Liquids|Biodiesel|w/o CCS (EJ/yr)\"),\n                \n                \n                \n                \n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,c(\"seso\"),                  name=\"PE|Biomass|Solids (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,pebio,c(\"sehe\"),                  name=\"PE|Biomass|Heat (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",\"seel\",                  name=\"PE|Coal|Electricity (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",\"seel\",teccs,            name=\"PE|Coal|Electricity|w/ CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",\"seel\",tenoccs,          name=\"PE|Coal|Electricity|w/o CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",\"sega\",                  name=\"PE|Coal|Gases (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",\"sega\",teccs,            name=\"PE|Coal|Gases|w/ CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",\"sega\",tenoccs,          name=\"PE|Coal|Gases|w/o CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",se_Liq,                  name=\"PE|Coal|Liquids (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",se_Liq,teccs,            name=\"PE|Coal|Liquids|w/ CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",se_Liq,tenoccs,          name=\"PE|Coal|Liquids|w/o CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",\"seh2\",                  name=\"PE|Coal|Hydrogen (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",\"seh2\",teccs,            name=\"PE|Coal|Hydrogen|w/ CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",\"seh2\",tenoccs,          name=\"PE|Coal|Hydrogen|w/o CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",c(\"sehe\"),               name=\"PE|Coal|Heat (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pecoal\",c(\"seso\"),               name=\"PE|Coal|Solids (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pegas\",\"seel\",                   name=\"PE|Gas|Electricity (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pegas\",\"seel\",teccs,             name=\"PE|Gas|Electricity|w/ CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pegas\",\"seel\",tenoccs,           name=\"PE|Gas|Electricity|w/o CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pegas\",c(\"sega\"),                name=\"PE|Gas|Gases (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pegas\",se_Liq,                   name=\"PE|Gas|Liquids (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pegas\",se_Liq,teccs,             name=\"PE|Gas|Liquids|w/ CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pegas\",se_Liq,tenoccs,           name=\"PE|Gas|Liquids|w/o CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pegas\",c(\"sehe\"),                name=\"PE|Gas|Heat (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pegas\",c(\"seh2\"),                name=\"PE|Gas|Hydrogen (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pegas\",c(\"seh2\"),teccs,          name=\"PE|Gas|Hydrogen|w/ CCS (EJ/yr)\"),\n                pe_carrier(demPE,dataoc,oc2te,sety,\"pegas\",c(\"seh2\"),tenoccs,        name=\"PE|Gas|Hydrogen|w/o CCS (EJ/yr)\"),\n                setNames(dimSums(mselect(prodSE,all_enty=\"pesol\",all_enty1=\"seel\"),dim=3),\"PE|Solar|Electricity (EJ/yr)\"))\n  tmp4 <- NULL\n  tmp4 <- mbind(tmp4, setNames( dimSums(demPE[,,c(\"peoil\",\"pecoal\",\"pegas\")],dim=3) \n                              + dimSums(demPE[,,c(\"pebiolc\",\"pebios\",\"pebioil\")],dim=3)   \n                              + dimSums(prodSE[,,c(\"pegeo\",\"pehyd\",\"pewin\",\"pesol\",\"peur\")],dim=3),\"PE (EJ/yr)\"))\n  tmp4 <- mbind(tmp4,setNames(fuelex[,,\"pebiolc.2\"],\"PE|Biomass|Residues (EJ/yr)\"))\n  tmp4 <- mbind(tmp4,setNames(dimSums(fuelex[,,c(\"pebioil\",\"pebios\")][enty2rlf],dim=3),\"PE|Production|Biomass|1st Generation (EJ/yr)\"))\n  tmp4 <- mbind(tmp4,setNames(( fuelex[,,\"pebiolc.1\"]\n                             + (1-p_costsPEtradeMp[,,\"pebiolc\"]) * Mport[,,\"pebiolc\"] - Xport[,,\"pebiolc\"]\n                             ),\"PE|Biomass|Energy Crops (EJ/yr)\"))\n#  tmp4 <- mbind(tmp4,setNames(0.001638 * (p_macBase[,,\"ch4gas\"] - p_macEmi[,,\"ch4gas\"]),\"PE|Gas|fromCH4MAC|Gas (EJ/yr)\"))\n#  tmp4 <- mbind(tmp4,setNames(0.001638 * 0.5 *(p_macBase[,,\"ch4coal\"] - p_macEmi[,,\"ch4coal\"]),\"PE|Gas|fromCH4MAC|Coalbed (EJ/yr)\"))\n#  tmp4 <- mbind(tmp4,setNames(0.001638 * (p_macBase[,,\"ch4wstl\"] - p_macEmi[,,\"ch4wstl\"]) ,\"PE|Gas|fromCH4MAC|Waste (EJ/yr)\"))\n  \n  out <- mbind(tmp1,tmp2,tmp3,tmp4)\n  # add global values\n  out <- mbind(out,dimSums(out,dim=1))\n  return(out)\n}\n",
    "created" : 1488300915913.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "828305809",
    "id" : "206041E6",
    "lastKnownWriteTime" : 1533202912,
    "last_content_update" : 1533202912,
    "path" : "~/Documents/work/libraries/remind/R/reportPE.R",
    "project_path" : "R/reportPE.R",
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}